{% extends "base.html" %}

{% block title %}{{ title }} - Matana CMS{% endblock %}

{% block extra_css %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
    .form-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .preview-image {
        max-height: 200px;
        object-fit: cover;
    }
    
    .ql-editor {
        min-height: 300px;
    }
    
    .form-section {
        transition: all 0.3s ease;
    }
    
    .form-section:hover {
        transform: translateY(-2px);
    }
    
    .image-drop-zone {
        border: 2px dashed #e5e7eb;
        transition: all 0.3s ease;
    }
    
    .image-drop-zone.drag-over {
        border-color: #004AAD;
        background-color: rgba(0,74,173,0.05);
    }
    
    .floating-toolbar {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        z-index: 50;
    }
    
    @keyframes slideIn {
        from { transform: translateY(100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    
    .floating-toolbar {
        animation: slideIn 0.3s ease-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="form-container px-4">
        <form id="articleForm" method="POST" action="{% url 'article_save' %}" enctype="multipart/form-data">
            {% csrf_token %}
            {% if article %}
            <input type="hidden" name="article_id" value="{{ article.id }}">
            {% endif %}
            
            <!-- Header -->
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-2xl font-bold text-gray-900">{{ title }}</h1>
                <div class="flex items-center space-x-4">
                    <a href="{% url 'content_dashboard' %}" class="text-gray-600 hover:text-gray-800">
                        <i class="fas fa-times mr-2"></i>
                        Cancel
                    </a>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Main Content -->
                <div class="lg:col-span-2 space-y-8">
                    <!-- Basic Info -->
                    <div class="form-section bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-lg font-semibold mb-6">Basic Information</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                                <input type="text" 
                                       name="title" 
                                       value="{{ article.title|default:'' }}"
                                       class="w-full rounded-lg border-gray-300 focus:border-matana-blue focus:ring focus:ring-blue-200"
                                       required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Slug</label>
                                <input type="text" 
                                       name="slug" 
                                       value="{{ article.slug|default:'' }}"
                                       class="w-full rounded-lg border-gray-300 focus:border-matana-blue focus:ring focus:ring-blue-200">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Excerpt</label>
                                <textarea name="excerpt" 
                                          rows="3"
                                          class="w-full rounded-lg border-gray-300 focus:border-matana-blue focus:ring focus:ring-blue-200">{{ article.excerpt|default:'' }}</textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Content Editor -->
                    <div class="form-section bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-lg font-semibold mb-6">Content</h2>
                        <div id="editor">{{ article.content|safe }}</div>
                        <input type="hidden" name="content" id="content">
                    </div>
                </div>
                
                <!-- Sidebar -->
                <div class="space-y-8">
                    <!-- Publishing Options -->
                    <div class="form-section bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-lg font-semibold mb-6">Publishing</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                <select name="status" class="w-full rounded-lg border-gray-300 focus:border-matana-blue focus:ring focus:ring-blue-200">
                                    <option value="draft" {% if article.status == 'draft' %}selected{% endif %}>Draft</option>
                                    <option value="published" {% if article.status == 'published' %}selected{% endif %}>Published</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                                <select name="category" class="w-full rounded-lg border-gray-300 focus:border-matana-blue focus:ring focus:ring-blue-200" required>
                                    <option value="">Select Category</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}" {% if article.category_id == category.id %}selected{% endif %}>
                                        {{ category.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" 
                                       name="is_featured" 
                                       id="is_featured"
                                       {% if article.is_featured %}checked{% endif %}
                                       class="rounded border-gray-300 text-matana-blue focus:ring-blue-200">
                                <label for="is_featured" class="ml-2 text-sm text-gray-700">Set as featured article</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Featured Image -->
                    <div class="form-section bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-lg font-semibold mb-6">Featured Image</h2>
                        <div class="image-drop-zone rounded-lg p-4 text-center" id="dropZone">
                            {% if article.featured_image %}
                            <img src="{{ article.featured_image.url }}" 
                                 alt="" 
                                 class="preview-image rounded-lg mb-4 mx-auto">
                            {% endif %}
                            <div class="space-y-2">
                                <svg class="w-12 h-12 mx-auto text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                          d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                </svg>
                                <p class="text-sm text-gray-500">
                                    Drag and drop an image here or
                                    <label class="text-matana-blue hover:text-blue-700 cursor-pointer">
                                        browse
                                        <input type="file" 
                                               name="featured_image" 
                                               accept="image/*"
                                               class="hidden"
                                               id="imageInput">
                                    </label>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SEO -->
                    <div class="form-section bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-lg font-semibold mb-6">SEO</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Meta Description</label>
                                <textarea name="meta_description" 
                                          rows="3"
                                          class="w-full rounded-lg border-gray-300 focus:border-matana-blue focus:ring focus:ring-blue-200">{{ article.meta_description|default:'' }}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Meta Keywords</label>
                                <input type="text" 
                                       name="meta_keywords" 
                                       value="{{ article.meta_keywords|default:'' }}"
                                       class="w-full rounded-lg border-gray-300 focus:border-matana-blue focus:ring focus:ring-blue-200">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Floating Save Toolbar -->
            <div class="floating-toolbar">
                <div class="bg-white rounded-xl shadow-lg p-4 flex items-center space-x-4">
                    <button type="submit" 
                            class="bg-matana-blue text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                        <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
                        </svg>
                        Save Article
                    </button>
                    <button type="submit" 
                            name="status" 
                            value="published"
                            class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center">
                        <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M5 13l4 4L19 7"/>
                        </svg>
                        Publish
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
    // Initialize Quill editor
    const quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'align': [] }],
                ['link', 'image'],
                ['clean']
            ]
        }
    });
    
    // Handle form submission
    document.getElementById('articleForm').addEventListener('submit', function() {
        document.getElementById('content').value = quill.root.innerHTML;
    });
    
    // Image upload preview
    const dropZone = document.getElementById('dropZone');
    const imageInput = document.getElementById('imageInput');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults (e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight(e) {
        dropZone.classList.add('drag-over');
    }
    
    function unhighlight(e) {
        dropZone.classList.remove('drag-over');
    }
    
    dropZone.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    }
    
    imageInput.addEventListener('change', function() {
        handleFiles(this.files);
    });
    
    function handleFiles(files) {
        if (files.length > 0) {
            const file = files[0];
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = dropZone.querySelector('img') || document.createElement('img');
                    img.src = e.target.result;
                    img.classList.add('preview-image', 'rounded-lg', 'mb-4', 'mx-auto');
                    if (!dropZone.querySelector('img')) {
                        dropZone.insertBefore(img, dropZone.firstChild);
                    }
                }
                reader.readAsDataURL(file);
            }
        }
    }
</script>
{% endblock %} 